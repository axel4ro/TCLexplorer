<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TCL dApp ¬∑ xPortal connect (WalletConnect v2)</title>
<style>
  :root{--bdr:#e5e7eb;--muted:#6b7280;--txt:#111827;--bg:#fff;--mono:#f3f4f6;--brand:#10b981}
  *{box-sizing:border-box}body{margin:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);background:var(--bg)}
  .wrap{max-width:920px;margin:auto}
  .card{border:1px solid var(--bdr);border-radius:16px;padding:18px;margin:14px 0}
  h1{margin:0 0 8px;font-size:24px} .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--bdr);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--mono);padding:6px 8px;border-radius:10px;word-break:break-all}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;align-items:start}
  #qrModal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:50}
  #qrBox{background:#111;padding:16px;border-radius:16px;max-width:360px}
  #qrBox h3{color:#fff;margin:0 0 10px;font-weight:600}
  #qr{width:320px;max-width:100%}
  /* Mobile sheet */
  #sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -10px 30px rgba(0,0,0,.15);padding:16px;display:none;z-index:60}
  #sheet h3{margin:0 0 8px}
  #sheet p{margin:6px 0 12px;color:#374151;font-size:14px}
</style>

<div class="wrap">
  <div class="card">
    <h1>TCL dApp ‚Äì Connect xPortal</h1>
    <p class="muted">Conectare cu xPortal prin WalletConnect v2 (SDK MultiversX). Desktop: QR. Mobil: deeplink √Æn app.</p>
  </div>

  <div class="card">
    <h2>Connection</h2>
    <div class="row" style="margin-bottom:10px">
      <button id="btnConnect" class="btn primary">Connect xPortal</button>
      <button id="btnDisconnect" class="btn">Disconnect</button>
    </div>
    <div class="kv">
      <div class="muted">Status</div><div id="status" class="mono">disconnected</div>
      <div class="muted">Address</div><div id="address" class="mono">‚Äî</div>
      <div class="muted">Network</div><div id="network" class="mono">mvx:1 (mainnet)</div>
    </div>
  </div>

  <div class="card">
    <h2>Sign Message</h2>
    <div class="row" style="margin-bottom:10px">
      <input id="msg" class="mono" style="flex:1" value="TCL-VERIFY" />
      <button id="btnRand" class="btn">Random Nonce</button>
      <button id="btnSign" class="btn">Sign</button>
    </div>
    <div class="kv">
      <div class="muted">Signature</div><div id="sig" class="mono">‚Äî</div>
    </div>
  </div>
</div>

<!-- Desktop QR modal -->
<div id="qrModal">
  <div id="qrBox">
    <h3>Scan with xPortal</h3>
    <div id="qr"></div>
    <div class="muted" style="color:#cbd5e1;margin-top:8px">Deschide xPortal pe telefon »ôi scaneazƒÉ.</div>
  </div>
</div>

<!-- Mobile sheet (user gesture for deeplink) -->
<div id="sheet">
  <h3>Open in xPortal</h3>
  <p>ApasƒÉ butonul de mai jos pentru a continua conectarea √Æn aplica»õia xPortal.</p>
  <div class="row">
    <button id="btnOpenXPortal" class="btn primary">Open xPortal</button>
    <button id="btnCancelOpen" class="btn">Cancel</button>
  </div>
  <p class="muted" id="sheetHint" style="margin-top:10px;display:none">DacƒÉ nu se deschide, apasƒÉ din nou ‚ÄûOpen xPortal‚Äù.</p>
</div>

<script type="module">
import { WalletConnectV2Provider as WalletConnectProvider } from "https://esm.sh/@multiversx/sdk-wallet-connect-provider@6.1.2";
import { SignableMessage } from "https://esm.sh/@multiversx/sdk-core@13.15.0";
import QRCode from "https://esm.sh/qrcode@1.5.3";
import { Buffer } from "https://esm.sh/buffer@6.0.3";     // üëà ADƒÇUGAT
// face Buffer disponibil global (unele utilitare din SDK √Æl folosesc)
if (!globalThis.Buffer) globalThis.Buffer = Buffer;


const WC_PROJECT_ID = "3b2862ec02219f2359a7d54b5f0f46ff";
const RELAY_URL     = "wss://relay.walletconnect.com";
const CHAIN_ID      = "1"; // "1"=mainnet, "T"=testnet, "D"=devnet
const MVX_CHAIN     = `mvx:${CHAIN_ID}`;

const $ = id => document.getElementById(id);
const statusEl = $("status"), addrEl = $("address"), netEl = $("network");
const sigEl = $("sig"), msgEl = $("msg");
const btnConnect = $("btnConnect"), btnDisconnect = $("btnDisconnect");
const btnSign = $("btnSign"), btnRand = $("btnRand");
const qrModal = $("qrModal"), qrDiv = $("qr");
const sheet = $("sheet"), btnOpenXPortal = $("btnOpenXPortal"), btnCancelOpen = $("btnCancelOpen"), sheetHint = $("sheetHint");

let provider = null;
let pendingApproval = null;
let lastUri = null;

const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

function setConnected(address){
  statusEl.textContent = "connected";
  addrEl.textContent = address || "‚Äî";
  netEl.textContent = `${MVX_CHAIN} (mainnet)`;
}
function setDisconnected(){
  statusEl.textContent = "disconnected";
  addrEl.textContent = "‚Äî";
  sigEl.textContent = "‚Äî";
}
async function openQR(uri){
  const svg = await QRCode.toString(uri, { type: "svg", margin: 1 });
  qrDiv.innerHTML = svg;
  qrModal.style.display = "grid";
}
function closeQR(){
  qrModal.style.display = "none";
  qrDiv.innerHTML = "";
}
function openSheet(){
  sheet.style.display = "block";
}
function closeSheet(){
  sheet.style.display = "none";
}

async function initProvider(){
  if (provider) return provider;

  const callbacks = {
    onClientLogin: async () => {
      closeQR(); closeSheet();
      const address = await provider.getAddress();
      setConnected(address);
    },
    onClientLogout: async () => {
      setDisconnected();
    }
  };

  provider = new WalletConnectProvider(
    callbacks,
    CHAIN_ID,
    RELAY_URL,
    WC_PROJECT_ID,
    { logger: "error" }
  );

  await provider.init();
  return provider;
}

function buildDeeplink(uri){
  const u = encodeURIComponent(uri);
  // douƒÉ variante cunoscute
  return [
    `xportal://walletconnect?uri=${u}`,
    `xportal://wc?uri=${u}`
  ];
}

async function startConnect(){
  await initProvider();

  // ceri metodele minime; po»õi adƒÉuga »ôi altele (mvx_signTransactions etc.)
  const { uri, approval } = await provider.connect({
    methods: ["mvx_signMessage"]
  });

  lastUri = uri;
  pendingApproval = approval;

  if (isMobile()) {
    // iOS/Android: cere gesture (buton) ‚Üí deschide deeplink
    openSheet();
    sheetHint.style.display = "none";
  } else {
    await openQR(uri);
  }

  // finalizeazƒÉ login-ul (a»ôteaptƒÉ aprobarea din xPortal)
  await provider.login({ approval });
}

btnConnect.onclick = async () => {
  try {
    await startConnect();
  } catch (e) {
    closeQR(); closeSheet();
    if (/rejected/i.test(e?.message || "")) {
      alert("Conectarea a fost respinsƒÉ √Æn xPortal. √éncearcƒÉ din nou »ôi apasƒÉ Approve.");
    } else {
      alert("Connect error: " + (e?.message || e));
    }
  }
};

btnOpenXPortal.onclick = () => {
  if (!lastUri) return;
  const candidates = buildDeeplink(lastUri);
  let i = 0;
  // √ÆncercƒÉm 2 scheme cunoscute; dacƒÉ nu porne»ôte din prima, mai √ÆncearcƒÉ o datƒÉ
  const tryOpen = () => {
    if (i >= candidates.length) { sheetHint.style.display = ""; return; }
    window.location.href = candidates[i++];
    setTimeout(tryOpen, 600);
  };
  tryOpen();
};

btnCancelOpen.onclick = () => closeSheet();

btnDisconnect.onclick = async () => {
  try { if (provider) await provider.logout(); } catch {}
  closeQR(); closeSheet();
  setDisconnected();
};

btnSign.onclick = async () => {
  try {
    if (!provider) { alert("Not connected."); return; }

    const msgStr = (msgEl.value ?? "").toString();
    if (!msgStr.length) {
      alert("Message is empty."); 
      return;
    }

    // asigurƒÉ-te cƒÉ avem TextEncoder (Safari vechi)
    const enc = (typeof TextEncoder !== "undefined") ? new TextEncoder() : null;
    const bytes = enc ? enc.encode(msgStr) : Buffer.from(msgStr, "utf8");  // Uint8Array

    // construim explicit payloadul
    const message = new SignableMessage({ message: bytes });

    await provider.signMessage(message);

    const { signature, address } = message.toJSON();  // { signature: hex, ... }
    sigEl.textContent = signature || JSON.stringify(message.toJSON());
  } catch (e) {
    alert("Sign error: " + (e?.message || e));
  }
};


btnRand.onclick = () => {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let s = "TCL-";
  for (let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
  msgEl.value = s;
};

setDisconnected();
</script>
</html>
