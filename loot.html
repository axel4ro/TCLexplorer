<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loot Explorer</title>

<style>
/* =========================
   GLOBAL ‚Äî MOBILE FIRST
========================= */

html {
    font-size: 14px; /* üî• scale corect pe mobile */
}

body {
    background: #161a24;
    color: #f1f1f1;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 8px;
    line-height: 1.6;
}
/* =========================
   HEADER
========================= */

.header {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 18px;
}

.header-buttons {
    display: flex;
    gap: 10px;
}

.header-buttons a,
.header-buttons button {
    flex: 1;
    text-align: center;
    padding: 12px 8px;
    font-size: 15px;
}

.header-title {
    margin: 0;
    font-size: 24px;
    color: #2ff6de;
    font-weight: 700;
    border-bottom: 2px solid #249c8c;
    padding-bottom: 6px;
    text-align: center;
}

/* =========================
   BUTTONS
========================= */

.back-btn,
button {
    border-radius: 8px;
    background: #249c8c;
    color: #fff;
    font-weight: 600;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
	text-decoration: none !important;
}


/* =========================
   SECTION (CONTENT)
========================= */

.section {
    background: #1e2230;
    border: 1px solid #333;
    border-radius: 14px;
    padding: 16px;
    margin-top: 14px;
    width: 100%;
    box-sizing: border-box;
}
/* =========================
   LOOT TABLE CARD (Monster drops)
========================= */
.loot-box {
    background: linear-gradient(180deg, #1a1f2e, #141824);
    border: 1px solid #2a2f42;
    border-radius: 16px;
    padding: 18px;
    margin: 18px 0;
    box-shadow: 0 6px 16px rgba(0,0,0,0.45);
}

.loot-box h3 {
    margin: 0 0 6px 0;
    color: #2ff6de;
    font-size: 18px;
}

.loot-box p {
    margin: 0 0 14px 0;
    font-size: 14px;
    opacity: 0.9;
}
@media (max-width: 600px) {
    .loot-box {
        padding: 16px;
        margin: 16px 0;
        border-radius: 18px;
    }

    .loot-box h3 {
        font-size: 17px;
    }
}

/* =========================
   INPUT
========================= */

input {
    width: 75%;
    padding: 12px;
    border-radius: 8px;
    background: #1e2230;
    border: 1px solid #333;
    color: #fff;
    font-size: 16px;
    margin-bottom: 10px;
}

/* =========================
   TABLE ‚Üí CARD LIST
========================= */

.table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
}
/* =========================
   CARD TABLE (Items / Monsters list)
========================= */
.card-table th {
    display: none;
}
/* ===== LOOT TABLE GRID ===== */

.loot-grid {
    display: grid;
    grid-template-columns: 2.5fr 0.8fr 0.8fr 1fr;
    gap: 10px;
    align-items: center;
}

.loot-grid.header {
    color: #2ff6de;
    font-weight: 700;
    font-size: 14px;
    border-bottom: 1px solid #2a2f42;
    padding-bottom: 8px;
    margin-bottom: 8px;
}

.loot-grid.row {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.loot-grid.row:last-child {
    border-bottom: none;
}

/* Center numeric columns */
.loot-grid .center {
    text-align: center;
}

/* ===== MOBILE TWEAK ===== */
@media (max-width: 600px) {
    .loot-grid {
        grid-template-columns: 1.8fr 0.7fr 0.7fr 0.8fr;
        font-size: 13px;
    }
}


.row-click {
    cursor: pointer;
}

.row-click td {
    background: linear-gradient(180deg, #1a1f2e, #141824);
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.05);
    font-size: 16px;
}

.row-label {
    display: flex;
    align-items: center;
    gap: 14px;
}

.arrow {
    font-size: 20px;
    color: #2ff6de;
}

/* =========================
   DESKTOP OVERRIDES
========================= */

@media (min-width: 768px) {

    html {
        font-size: 16px;
    }

    body {
        padding: 20px;
    }

    .header-title {
        text-align: left;
        font-size: 26px;
    }

    .header-buttons {
        width: auto;
    }

    .header-buttons a,
    .header-buttons button {
        flex: none;
        padding: 10px 18px;
        font-size: 14px;
    }

    input {
        width: 280px;
        margin-bottom: 0;
    }

    .table th {
        display: table-cell;
        color: #2ff6de;
        padding: 10px;
    }
}
/* ===== CONTENT ACTION BUTTONS (Search / Next / Previous) ===== */
.section button {
    font-size: 16px;        /* üî• mai mare */
    padding: 12px 18px;     /* üî• mai aerisit */
    border-radius: 10px;
}
@media (max-width: 600px) {
    .section button {
        font-size: 18px;        /* üî• clar vizibil */
        padding: 14px 20px;     /* üî• tap-friendly */
        border-radius: 12px;
    }
}
.loot-grid.row:hover {
    background: rgba(47,246,222,0.05);
}
.loot-box + .loot-box {
    margin-top: 26px;
}

/* ===== ITEM ROW HOVER / ACTIVE ===== */

/* Desktop hover */
.row-click:hover td {
    background: linear-gradient(180deg, #20263a, #171c2b);
    border-color: rgba(47,246,222,0.35);
    box-shadow: 0 0 0 1px rgba(47,246,222,0.25),
                0 6px 16px rgba(0,0,0,0.6);
}

/* Mobile tap (while pressed) */
.row-click:active td {
    background: linear-gradient(180deg, #1e3340, #162028);
    border-color: rgba(47,246,222,0.6);
    box-shadow: inset 0 0 0 1px rgba(47,246,222,0.4);
}

/* Arrow animation for feedback */
.row-click:hover .arrow,
.row-click:active .arrow {
    transform: translateX(4px);
    transition: transform 0.15s ease;
}
/* =========================
   BUTTON ANIMATIONS (UX)
========================= */

.header-buttons a,
.header-buttons button,
.section button {
    transition:
        transform 0.18s ease,
        box-shadow 0.18s ease,
        background 0.18s ease,
        filter 0.18s ease;
    will-change: transform;
}

/* üñ±Ô∏è Hover (desktop) */
.header-buttons a:hover,
.header-buttons button:hover,
.section button:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow:
        0 6px 18px rgba(0,0,0,0.45),
        0 0 0 1px rgba(47,246,222,0.35);
    filter: brightness(1.08);
}

/* üëÜ Active / Tap (click + mobile press) */
.header-buttons a:active,
.header-buttons button:active,
.section button:active {
    transform: translateY(1px) scale(0.97);
    box-shadow:
        inset 0 2px 6px rgba(0,0,0,0.4),
        0 0 0 1px rgba(47,246,222,0.25);
    filter: brightness(0.95);
}

/* üß† Focus (keyboard / accessibility) */
.header-buttons a:focus-visible,
.header-buttons button:focus-visible,
.section button:focus-visible {
    outline: none;
    box-shadow:
        0 0 0 2px rgba(47,246,222,0.6),
        0 6px 16px rgba(0,0,0,0.5);
}

</style>
</head>

<body>

<div class="header">
    <div class="header-buttons">
        <a href="wiki.html" class="back-btn">‚¨ÖÔ∏è Back to WiKi</a>
        <button onclick="showItems()">Items</button>
        <button onclick="showMonsters()">Monsters</button>
    </div>

    <h1 class="header-title">Loot Explorer</h1>
</div>

<!-- <button onclick="showLootTables()">Loot Tables</button>-->

<div id="content"></div>

<script>
let DATA = null;

// State
let itemPage = 0;
let monsterPage = 0;
let lootPage = 0;

let itemSearch = "";
let monsterSearch = "";
let lootSearch = "";

// Drop rate formatter
function formatDrop(num) {
    return (num % 1 === 0) ? `${num}%` : `${num.toFixed(1)}%`;
}

const DROP_URL = "https://raw.githubusercontent.com/axel4ro/TCLexplorer/main/data/drop.json";

async function loadDropFromGitHub() {
    try {
        const res = await fetch(DROP_URL + "?t=" + Date.now());
        if (!res.ok) throw new Error("HTTP Error " + res.status);

        DATA = await res.json();
<!--         console.log("drop.json loaded automatically from GitHub!");-->
<!--         alert("drop.json loaded automatically from GitHub!");-->
showItems();
    } catch (err) {
        console.error("Failed loading GitHub drop.json:", err);
        alert("‚ùå Cannot load drop.json from GitHub! Check console for details.");
    }
}

loadDropFromGitHub();


/* ======================================================
    EXCLUDED
====================================================== */
// === ITEMS WE DO NOT WANT TO DISPLAY AT ALL ===
const EXCLUDED_ITEMS = [8, 9,];
// === MONSTERS WE DO NOT WANT TO DISPLAY AT ALL ===
const EXCLUDED_MONSTERS = [99, 100, 121, 117, 118, 120, 115, 116, 113, 114, 119, 122];
// === LOOT TABLES WE DO NOT WANT TO DISPLAY AT ALL ===
const EXCLUDED_LOOT_TABLES = [115, 116];


/* ======================================================
// === MANUAL LOOT TABLE ASSIGNMENTS ===
====================================================== */
// itemId : lootTableId
const MANUAL_LOOT = {
    1517: 228,  // Clam ‚Üí loot table 228
    1211: 51,    // Moonlight Treasure Chest ‚Üí loot table 51
	1213: 53,
	1422: 168,
	1212: 52,
	1509: 262
};

/* ======================================================
    PAGE: ITEMS
====================================================== */
	function showItems() {
		if (!DATA) return alert("Load JSON first!");

	const items = DATA.itemTemplates.filter(i => {

		// 0. Excluded items (manual hidden)
		if (EXCLUDED_ITEMS.includes(i.id)) return false;

		const name = i.name.toLowerCase();
		if (!name.includes(itemSearch.toLowerCase())) return false;

		// 1. Loot tables care con»õin itemul
		const relevantTables = DATA.lootTables.filter(t =>
			t.items.some(it => it.item === i.id)
		);

		// 2. VerificƒÉm dacƒÉ vreun lootTable este folosit de un mob
		const isUsedByMob = relevantTables.some(t =>
			Object.values(DATA.mobLoot).some(mobDrops =>
				mobDrops.some(d => d.lootTable === t.id)
			)
		);

		// 3. Check manual assignment
		const hasManualDrop = MANUAL_LOOT[i.id] !== undefined;

		// 4. Include only items that have a REAL source
		return isUsedByMob || hasManualDrop;
	});
// SORT items alphabetically
items.sort((a, b) => a.name.localeCompare(b.name));


    const perPage = 10;
    const totalPages = Math.ceil(items.length / perPage);
    if (itemPage >= totalPages) itemPage = 0;

    let start = itemPage * perPage;
    let end = start + perPage;

    let html = `
    <div class="section">
    <h2>  Items (Page ${itemPage+1} / ${totalPages || 1})</h2>

    <input id="itemInput" type="text" placeholder="Search item..." value="${itemSearch}">
    <button onclick="applyItemSearch()">Search</button>

	<table class="table">
		<tr><th>Name</th></tr>

    `;

	items.slice(start, end).forEach(it => {
		html += `
<tr class="row-click" onclick="openItem(${it.id})">
    <td class="left">
        <span class="row-label">
            <span class="arrow">‚Ä∫</span>
            ${it.name}
        </span>
    </td>
</tr>`;
	});

    html += `</table>`;

    if (itemPage > 0) html += `<button onclick="itemPage--; showItems()">Previous</button>`;
    if (itemPage < totalPages - 1) html += `<button onclick="itemPage++; showItems()">Next</button>`;

    html += `</div>`;
    document.getElementById("content").innerHTML = html;

    document.getElementById("itemInput").addEventListener("keydown", e => {
        if (e.key === "Enter") applyItemSearch();
    });
}

function applyItemSearch() {
    itemSearch = document.getElementById("itemInput").value;
    itemPage = 0;
    showItems();
}


function openItem(id) {
    const item = DATA.itemTemplates.find(x => x.id === id);
    const mobMap = Object.fromEntries(DATA.mobTemplates.map(m => [m.id, m.name]));

    // loot tables that naturally drop this item
	const lootTables = DATA.lootTables.filter(t =>
		!EXCLUDED_LOOT_TABLES.includes(t.id) &&
		t.items.some(it => it.item === id)
	);


    let html = `<div class="section"><h2>  ${item.name}</h2>`;

// üî• SHOW CONTAINS FIRST (manual loot table)
if (MANUAL_LOOT[id]) {
    const ltId = MANUAL_LOOT[id];
    const table = DATA.lootTables.find(t => t.id === ltId);
    const itemMap = Object.fromEntries(DATA.itemTemplates.map(i => [i.id, i.name]));

    // calcul dropRate corect
    let sorted = [...table.items].sort((a, b) => a.chance - b.chance);
    sorted.forEach((x, i) => x.dropRate = i === 0 ? x.chance : x.chance - sorted[i - 1].chance);

html += `
    <h3>Contains:</h3>

    <div class="loot-grid header">
        <div>Name</div>
        <div class="center">Min</div>
        <div class="center">Max</div>
        <div class="center">Drop%</div>
    </div>
`;


sorted.forEach(it => {
    html += `
        <div class="loot-grid row">
            <div>${itemMap[it.item]}</div>
            <div class="center">${it.count}</div>
            <div class="center">${it.count_max}</div>
            <div class="center">${formatDrop(it.dropRate)}</div>
        </div>
    `;
});


    html += `</table><br>`;
}


    let drops = [];

    lootTables.forEach(lt => {
	if (EXCLUDED_LOOT_TABLES.includes(lt.id)) return;
        for (const mobId in DATA.mobLoot) {
            if (DATA.mobLoot[mobId].some(d => d.lootTable === lt.id)) {
                drops.push({
                    mob: mobMap[mobId],
                    table: lt,
                    mobId: mobId
                });
            }
        }
    });

	// === CASE 1: ITEM HAS NO MONSTER DROP ===
// === CASE 1: ITEM HAS NO MONSTER DROP ===
if (drops.length === 0) {
    html += `<p>No monster drops this item.</p>`;
    html += `<button onclick="showItems()">Back</button></div>`;
    document.getElementById("content").innerHTML = html;
    return;
}


// === CASE 2: ITEM HAS NATURAL DROPS ===
html += `<h3>Dropped by:</h3>`;
let shownMobs = new Set();
drops.forEach(d => {

    // DropChance al mob-ului pentru lootTable
    const mobDrop = DATA.mobLoot[d.mobId].find(x => x.lootTable === d.table.id);

    let itemDrop = 0;

    let sorted = [...d.table.items].sort((a, b) => a.chance - b.chance);
    let prev = 0;

    for (const it of sorted) {
        const rate = it.chance - prev;
        if (it.item === id) {
            itemDrop = rate;
            break;
        }
        prev = it.chance;
    }

	if (itemDrop > 0 && !shownMobs.has(d.mob)) {
		shownMobs.add(d.mob);

		const isSingleItemTable = d.table.items.length === 1;

		const displayDrop = isSingleItemTable
			? mobDrop.dropChance        // üî• 1 item ‚Üí mob chance
			: itemDrop;                 // üî• multiple items ‚Üí table %

		html += `
			<p>
				<b>${d.mob}</b> ‚Äî
				Drop Chance: <b>${formatDrop(displayDrop)}</b>
			</p>
		`;
	}

});


    html += `<button onclick="showItems()">Back</button></div>`;
    document.getElementById("content").innerHTML = html;
}


function assignLootToItem(id) {
    const ltId = document.getElementById("assignLT").value;
    openLootTable(parseInt(ltId));
}


/* ======================================================
    PAGE: LOOT TABLES BROWSER
====================================================== */
function showLootTables() {
    if (!DATA) return alert("Load JSON first!");

    const tables = DATA.lootTables.filter(t =>
        String(t.id).includes(lootSearch)
    );

    const perPage = 10;
    const totalPages = Math.ceil(tables.length / perPage);
    if (lootPage >= totalPages) lootPage = 0;

    let start = lootPage * perPage;
    let end = start + perPage;

    let html = `
    <div class="section">
    <h2>üé≤ Loot Tables (Page ${lootPage+1} / ${totalPages || 1})</h2>

    <input id="lootInput" placeholder="Search loot table..." value="${lootSearch}">
    <button onclick="applyLootSearch()">Search</button>

    <table class="table">
    <tr><th>ID</th><th class="center">Open</th></tr>
    `;

    tables.slice(start, end).forEach(t => {
        html += `
        <tr>
            <td class="left">${t.id}</td>
            <td class="center"><button onclick="openLootTable(${t.id})">View</button></td>
        </tr>`;
    });

    html += `</table>`;

    if (lootPage > 0) html += `<button onclick="lootPage--; showLootTables()">Previous</button>`;
    if (lootPage < totalPages - 1) html += `<button onclick="lootPage++; showLootTables()">Next</button>`;

    html += `</div>`;

    document.getElementById("content").innerHTML = html;

    document.getElementById("lootInput").addEventListener("keydown", e => {
        if (e.key === "Enter") applyLootSearch();
    });
}

function applyLootSearch() {
    lootSearch = document.getElementById("lootInput").value;
    lootPage = 0;
    showLootTables();
}


/* ======================================================
// =====================================================================================
//   LOOT TABLE DETAILS PAGE ‚Äî CUSTOM TITLE WHEN CALLED FROM AN ITEM
// =====================================================================================
*/
function openLootTable(id, fromItemId = null) {

    const table = DATA.lootTables.find(t => t.id === id);
    const itemMap = Object.fromEntries(DATA.itemTemplates.map(i => [i.id, i.name]));
    const mobMap = Object.fromEntries(DATA.mobTemplates.map(m => [m.id, m.name]));

    // SortƒÉm itemele dupƒÉ chance pentru drop rate corect
    let sorted = [...table.items].sort((a,b)=>a.chance - b.chance);
    sorted.forEach((x,i)=> x.dropRate = i===0 ? x.chance : x.chance - sorted[i-1].chance);

    // Titlu corect dacƒÉ vine dintr-un item
    let title = `üé≤ Loot Table ${id}`;
    if (fromItemId !== null) {
        const itemName = itemMap[fromItemId];
        title = `  ${itemName}`;
    }

    let html = `<div class="section"><h2>${title}</h2>`;

    // TABELUL CU ITEME
    html += `<table class="table">
        <tr><th>Name</th><th class="center">Min</th><th class="center">Max</th><th class="center">Drop %</th></tr>
    `;

    sorted.forEach(it => {
        html += `
        <tr>
            <td class="left">${itemMap[it.item]}</td>
            <td class="center">${it.count}</td>
            <td class="center">${it.count_max}</td>
            <td class="center">${formatDrop(it.dropRate)}</td>
        </tr>`;
    });

    html += `</table><br>`;

    // MON»òTRII CARE FOLOSESC ACEASTƒÇ LOOT TABLE
    for (const mobId in DATA.mobLoot) {
        if (DATA.mobLoot[mobId].some(d => d.lootTable == id)) {
            const ml = DATA.mobLoot[mobId].find(d => d.lootTable == id);
            html += `<p><b>${mobMap[mobId]}</b> ‚Äî Drop Chance: ${formatDrop(ml.dropChance)}</p>`;
        }
    }

    // üî•üî• BACK BUTTON LOGIC CORECT
    if (fromItemId !== null) {
        html += `<button onclick="showItems()">Back</button></div>`;
    } else {
        html += `<button onclick="showLootTables()">Back</button></div>`;
    }

    document.getElementById("content").innerHTML = html;
}



/* ======================================================
    MONSTERS PAGE
====================================================== */
function showMonsters() {
    if (!DATA) return alert("Load JSON first!");

    const mobs = DATA.mobTemplates.filter(m => {

        // 0. Exclude manual
        if (EXCLUDED_MONSTERS.includes(m.id)) return false;

        // 1. Exclude mon»ôtrii fƒÉrƒÉ loot √Æn JSON
        const mobDrops = DATA.mobLoot[m.id];
        if (!mobDrops) return false; // monstrul NU existƒÉ √Æn mobLoot ‚Üí ascuns

        // 2. Exclude dacƒÉ toate drop-urile au dropChance = 0
        const hasRealDrop = mobDrops.some(d => d.dropChance > 0);
        if (!hasRealDrop) return false;

        // 3. Search filter
        return m.name.toLowerCase().includes(monsterSearch.toLowerCase());
    });

    // SORTARE ALFABETICƒÇ
    mobs.sort((a, b) => a.name.localeCompare(b.name));

    const perPage = 10;
    const totalPages = Math.ceil(mobs.length / perPage);
    if (monsterPage >= totalPages) monsterPage = 0;

    let start = monsterPage * perPage;
    let end = start + perPage;

    let html = `
    <div class="section">
    <h2>  Monsters (Page ${monsterPage+1} / ${totalPages || 1})</h2>

    <input id="monsterInput" placeholder="Search monster..." value="${monsterSearch}">
    <button onclick="applyMonsterSearch()">Search</button>

	<table class="table">
		<tr><th>Name</th></tr>

    `;

	mobs.slice(start, end).forEach(m => {
		html += `
<tr class="row-click" onclick="openMonster(${m.id})">
    <td class="left">
        <span class="row-label">
            <span class="arrow">‚Ä∫</span>
            ${m.name}
        </span>
    </td>
</tr>
`;
	});
		
    html += `</table>`;

    if (monsterPage > 0) html += `<button onclick="monsterPage--;showMonsters()">Previous</button>`;
    if (monsterPage < totalPages - 1) html += `<button onclick="monsterPage++;showMonsters()">Next</button>`;

    html += `</div>`;

    document.getElementById("content").innerHTML = html;

    document.getElementById("monsterInput").addEventListener("keydown", e => {
        if (e.key === "Enter") applyMonsterSearch();
    });
}



function applyMonsterSearch() {
    monsterSearch = document.getElementById("monsterInput").value;
    monsterPage = 0;
    showMonsters();
}


/* ======================================================
    MONSTER DETAILS
====================================================== */
function openMonster(id) {
    const mob = DATA.mobTemplates.find(m => m.id == id);
    const drops = DATA.mobLoot[id];

    const itemMap = Object.fromEntries(DATA.itemTemplates.map(i => [i.id, i.name]));

    let html = `<div class="section"><h2>  ${mob.name}</h2>`;

    // üî• FiltrƒÉm loot-urile cu dropChance > 0
    const validDrops = drops.filter(d => d.dropChance > 0);

    if (validDrops.length === 0) {
        html += `<p>No loot with a drop chance > 0.</p>`;
    }

	validDrops.forEach(d => {
	   if (EXCLUDED_LOOT_TABLES.includes(d.lootTable)) return;
		const lt = DATA.lootTables.find(t => t.id === d.lootTable);

		html += `
		<div class="loot-box">

			<h3>Loot Table ${d.lootTable}</h3>
			<p>Mob Drop Chance: <b>${formatDrop(d.dropChance)}</b></p>

    <div class="loot-grid header">
        <div>Name</div>
        <div class="center">Min</div>
        <div class="center">Max</div>
        <div class="center">Drop%</div>
    </div>
		`;

    // calculare dropRate corectƒÉ
    let sorted = [...lt.items].sort((a,b)=>a.chance - b.chance);
    sorted.forEach((x,i)=> x.dropRate = i===0 ? x.chance : x.chance - sorted[i-1].chance);

sorted.forEach(it => {
    html += `
        <div class="loot-grid row">
            <div>${itemMap[it.item]}</div>
            <div class="center">${it.count}</div>
            <div class="center">${it.count_max}</div>
            <div class="center">${formatDrop(it.dropRate)}</div>
        </div>
    `;
});


    html += `
        </table>
    </div>
    `;
});


    html += `<button onclick="showMonsters()">Back</button></div>`;
    document.getElementById("content").innerHTML = html;
}

</script>

</body>
</html>



