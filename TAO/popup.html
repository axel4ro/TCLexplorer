<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TAO Wallet – Subnet 114 (Bittensor Testnet)</title>

<script type="importmap">
{
  "imports": {
    "@polkadot/api": "https://cdn.jsdelivr.net/npm/@polkadot/api@10.13.1/+esm",
    "@polkadot/keyring": "https://cdn.jsdelivr.net/npm/@polkadot/keyring@12.6.2/+esm",
    "@polkadot/util-crypto": "https://cdn.jsdelivr.net/npm/@polkadot/util-crypto@12.6.2/+esm"
  }
}
</script> 
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #000;
    color: #fff;
    margin: 0;
    padding: 0;
  }
  .container {
    padding: 20px;
    max-width: 440px;
    margin: auto;
  }
  h1, h2 { text-align: center; color: #23c1a0; }
  .card {
    background: #111;
    border-radius: 14px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.35);
  }
  input {
    width: 100%;
    background: #0b0b0b;
    color: #fff;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px;
    margin: 6px 0;
  }
  button {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background: #0a84ff;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
    transition: 0.2s;
  }
  button:hover { background: #1a94ff; }
  .hidden { display: none; }
  .info {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 10px;
    margin-top: 8px;
    font-size: 0.9rem;
    color: #ccc;
  }
  .net-item {
    background: #1a1a1a;
    padding: 12px;
    border-radius: 8px;
    margin: 8px 0;
  }
  .net-item small { color: #aaa; }
  .soon {
    opacity: 0.5;
    background: #333;
  }
  .address-text {
  display: inline-block;
  word-break: break-all;
  background: #0b0b0b;
  padding: 6px 8px;
  border-radius: 6px;
  font-family: monospace;
  font-size: 0.9rem;
  user-select: text;
  color: #fff;
  max-width: 100%;
}

.copy-btn {
  margin-left: 6px;
  background: #23c1a0;
  color: #000;
  border: none;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.8rem;
}

.copy-btn:hover {
  background: #1ee0a9;
}

.copy-msg {
  margin-left: 8px;
  color: #23c1a0;
  font-weight: 600;
  font-size: 0.85rem;
}

#taoChange {
  font-weight: 600;
  font-size: 0.95rem;
}
#taoPrice {
  font-weight: 600;
  font-size: 1rem;
}

#sendSection input {
  margin-top: 8px;
  background: #0b0b0b;
  color: #fff;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 8px;
}
#sendSection button {
  margin-top: 10px;
  background: #23c1a0;
  color: #000;
  font-weight: 600;
}
#sendSection button:hover {
  background: #1ee0a9;
}

</style>
</head>
<body>
<div class="container">

  <h1>🪙 Wallet</h1>
  <p style="text-align:center;">Subnet 114 – Bittensor</p>

  <!-- SETUP -->
  <div id="setup" class="card">
    <button id="createBtn">✨ Create Wallet</button>
    <button id="showImportBtn">📥 Import Mnemonic</button>
    <button id="importJsonBtn">📄 Import JSON</button>

    <div id="importSection" class="hidden">
      <div class="info">🔑 Enter your 12–24 word secret recovery phrase (mnemonic).</div>
      <input id="mnemonicInput" placeholder="e.g. siege pepper lawsuit balcony ..." />
      <button id="importBtn">✅ Confirm Import</button>
    </div>

    <input id="jsonInput" type="file" accept=".json" style="display:none" />
  </div>

<!-- WALLET -->
<div id="wallet" class="card hidden">
  <p><b>Address:</b><br>
    <span id="address" class="address-text">-</span>
    <button id="copyBtn" class="copy-btn">📋 Copy</button>
    <span id="copyMsg" class="copy-msg hidden">✅ Copied!</span>
  </p>
<p><b>TAO Price:</b> 
  <span id="taoPrice">Loading...</span> 
  <span id="taoChange" style="margin-left:6px;">--</span>
</p>


  <p><b>Balance:</b> <span id="balance">0</span> TAO (<span id="usdValue">$0.00</span>)</p>
  <button id="refreshBtn">🔄 Refresh Balance</button>
  <button id="sendBtn">📤 Send TAO</button>

<div id="sendSection" class="hidden info">
  <input id="toAddress" placeholder="Recipient address (5Ec...)" />
  <input id="amount" placeholder="Amount (TAO)" type="number" min="0" step="0.0001" />
  <button id="confirmSendBtn">✅ Confirm Send</button>
  <div id="txStatus" style="margin-top:8px;color:#23c1a0;font-size:0.9rem;"></div>
</div>

  <button id="exportBtn">💾 Export JSON</button>
  <button id="settingsBtn">⚙️ Settings</button>
  <button id="disconnectBtn">🚪 Disconnect</button>
  <!-- TESTNET TOOLS -->
<div id="testnetTools" class="card hidden">
  <h2>🧪 Testnet Tools</h2>
  <p>Use these tools to get TAO and register your neuron on Subnet 114.</p>
  <button id="faucetBtn">💧 Get TAO from Faucet</button>
  <button id="registerBtn">🧠 Register Neuron (Hotkey)</button>
  <div id="registerStatus" style="margin-top:8px;color:#23c1a0;font-size:0.9rem;"></div>
</div>

</div>


  <!-- SETTINGS -->
  <div id="settings" class="card hidden">
    <h2>⚙️ Settings</h2>

    <button id="showNetworksBtn">🌐 Networks</button>
    <button class="soon">🧩 Extensions (soon)</button>
    <button class="soon">🔔 Notifications (soon)</button>
    <button id="backBtn">⬅️ Back to Wallet</button>

    <div id="networks" class="card hidden">
      <h2>🌐 Networks</h2>
      <div id="networkList"></div>
      <input id="rpcUrl" placeholder="RPC URL (wss://...)" />
      <input id="netName" placeholder="Network name" />
      <input id="symbol" placeholder="Token symbol (TAO)" />
      <input id="chainId" placeholder="Chain ID (9)" />
      <input id="networkId" placeholder="Network ID (42)" />
      <input id="type" placeholder="Protocol (Substrate)" value="Substrate" />
      <button id="addNetworkBtn">💾 Add Network</button>
    </div>
  </div>

</div>

<script type="module">
import { ApiPromise, WsProvider } from "@polkadot/api";
import { Keyring } from "@polkadot/keyring";
import { mnemonicGenerate, mnemonicValidate, mnemonicToMiniSecret, cryptoWaitReady, encodeAddress } from "@polkadot/util-crypto";

let api = null;
let wallet = null;
let currentNet = null;

// Default Network
const defaultNetwork = {
  name: "Bittensor Testnet",
  rpc: "wss://test.finney.opentensor.ai",
  symbol: "TAO",
  chainId: "9",
  networkId: "42",
  type: "Substrate"
};

// DOM
const setup = document.getElementById("setup");
const walletDiv = document.getElementById("wallet");
const settingsDiv = document.getElementById("settings");
const networksDiv = document.getElementById("networks");
const importSection = document.getElementById("importSection");
const addressEl = document.getElementById("address");
const balanceEl = document.getElementById("balance");

await cryptoWaitReady();
initNetworks();
await connectNetwork(defaultNetwork);

// Create Wallet
document.getElementById("createBtn").onclick = async () => {
  const mnemonic = mnemonicGenerate();
  const seed = mnemonicToMiniSecret(mnemonic);
  const keyring = new Keyring({ type: "sr25519" });
  wallet = keyring.addFromSeed(seed);
  const address = encodeAddress(wallet.publicKey, 42);
  localStorage.setItem("taowallet", JSON.stringify({ mnemonic, address }));
  alert(`✅ Wallet created!\n\nMnemonic:\n${mnemonic}`);
  showWallet(address);
};

// Show Import Mnemonic Section
document.getElementById("showImportBtn").onclick = () => {
  importSection.classList.toggle("hidden");
};

// Import Mnemonic
document.getElementById("importBtn").onclick = async () => {
  const mnemonic = document.getElementById("mnemonicInput").value.trim();
  if (!mnemonicValidate(mnemonic)) return alert("❌ Invalid mnemonic!");
  const seed = mnemonicToMiniSecret(mnemonic);
  const keyring = new Keyring({ type: "sr25519" });
  wallet = keyring.addFromSeed(seed);
  const address = encodeAddress(wallet.publicKey, 42);
  localStorage.setItem("taowallet", JSON.stringify({ mnemonic, address }));
  showWallet(address);
};

// Import JSON
document.getElementById("importJsonBtn").onclick = () => document.getElementById("jsonInput").click();
document.getElementById("jsonInput").onchange = async (e) => {
  const file = e.target.files[0];
  const text = await file.text();
  try {
    const data = JSON.parse(text);
    if (!data.mnemonic) throw 0;
    const seed = mnemonicToMiniSecret(data.mnemonic);
    const keyring = new Keyring({ type: "sr25519" });
    wallet = keyring.addFromSeed(seed);
    showWallet(data.address);
    localStorage.setItem("taowallet", JSON.stringify(data));
  } catch {
    alert("❌ Invalid JSON file");
  }
};

// Export JSON
document.getElementById("exportBtn").onclick = () => {
  const saved = localStorage.getItem("taowallet");
  const blob = new Blob([saved], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "taowallet.json";
  a.click();
};

// Disconnect
document.getElementById("disconnectBtn").onclick = () => {
  wallet = null;
  localStorage.removeItem("taowallet");
  walletDiv.classList.add("hidden");
  setup.classList.remove("hidden");
  settingsDiv.classList.add("hidden");
};

// Refresh Balance
document.getElementById("refreshBtn").onclick = updateBalance;

// Settings buttons
document.getElementById("settingsBtn").onclick = () => {
  walletDiv.classList.add("hidden");
  settingsDiv.classList.remove("hidden");
};

document.getElementById("backBtn").onclick = () => {
  settingsDiv.classList.add("hidden");
  walletDiv.classList.remove("hidden");
};

// Show networks
document.getElementById("showNetworksBtn").onclick = () => {
  networksDiv.classList.toggle("hidden");
};

// Networks
function initNetworks() {
  const nets = JSON.parse(localStorage.getItem("networks") || "[]");
  if (!nets.find(n => n.rpc === defaultNetwork.rpc)) nets.push(defaultNetwork);
  localStorage.setItem("networks", JSON.stringify(nets));
  renderNetworks();
}

function renderNetworks() {
  const nets = JSON.parse(localStorage.getItem("networks"));
  const list = document.getElementById("networkList");
  list.innerHTML = "";
  nets.forEach((n, i) => {
    const div = document.createElement("div");
    div.className = "net-item";
    div.innerHTML = `<b>${n.name}</b><br><small>${n.rpc}</small><br><button onclick="window.selectNet(${i})">Select</button>`;
    list.appendChild(div);
  });
}

window.selectNet = async (i) => {
  const nets = JSON.parse(localStorage.getItem("networks"));
  await connectNetwork(nets[i]);
  alert("✅ Switched to " + nets[i].name);
};

// Add network
document.getElementById("addNetworkBtn").onclick = () => {
  const rpc = document.getElementById("rpcUrl").value;
  const name = document.getElementById("netName").value;
  const symbol = document.getElementById("symbol").value;
  const chainId = document.getElementById("chainId").value;
  const networkId = document.getElementById("networkId").value;
  const type = document.getElementById("type").value;
  const nets = JSON.parse(localStorage.getItem("networks"));
  nets.push({ rpc, name, symbol, chainId, networkId, type });
  localStorage.setItem("networks", JSON.stringify(nets));
  renderNetworks();
  alert("✅ Network added!");
};

// Connect network
async function connectNetwork(net) {
  try {
    currentNet = net;
    const provider = new WsProvider(net.rpc);
    api = await ApiPromise.create({ provider });
    console.log("✅ Connected to " + net.name);
  } catch (e) {
    console.error("Connection error:", e);
  }
}

// Show wallet + activate testnet tools
async function showWallet(address) {
  addressEl.textContent = address;
  setup.classList.add("hidden");
  walletDiv.classList.remove("hidden");

  // 🧪 activează doar dacă suntem pe testnet
  if (currentNet.rpc.includes("test")) {
    document.getElementById("testnetTools").classList.remove("hidden");
  } else {
    document.getElementById("testnetTools").classList.add("hidden");
  }

  await updateBalance();
}

// Update balance
async function updateBalance() {
  if (!wallet || !api) return;
  try {
    const { data: balance } = await api.query.system.account(wallet.address);
    const tao = Number(balance.free.toString()) / 1e9;
    const taoFormatted = tao.toLocaleString(undefined, { 
  minimumFractionDigits: 0, 
  maximumFractionDigits: 4 
});
balanceEl.textContent = taoFormatted;


    const taoPrice = await fetchTaoPrice();
    const usdValue = (tao * taoPrice).toLocaleString(undefined, { 
  minimumFractionDigits: 2, 
  maximumFractionDigits: 2 
});
document.getElementById("usdValue").textContent = `$${usdValue}`;


  } catch {
    balanceEl.textContent = "Error";
    document.getElementById("usdValue").textContent = "$0.00";
  }
}


// Auto login
const saved = JSON.parse(localStorage.getItem("taowallet") || "{}");
if (saved.mnemonic && saved.address) {
  const seed = mnemonicToMiniSecret(saved.mnemonic);
  const keyring = new Keyring({ type: "sr25519" });
  wallet = keyring.addFromSeed(seed);
  showWallet(saved.address);
}

// --- Copy Address ---
document.getElementById("copyBtn").onclick = async () => {
  const addr = document.getElementById("address").textContent.trim();
  await navigator.clipboard.writeText(addr);
  const msg = document.getElementById("copyMsg");
  msg.classList.remove("hidden");
  setTimeout(() => msg.classList.add("hidden"), 1500);
};

// --- TAO Price Fetch (cu color și memorare) ---
let lastPrice = 0;

async function fetchTaoPrice() {
  try {
    // Binance endpoint cu datele de 24h
    const res = await fetch("https://api.binance.com/api/v3/ticker/24hr?symbol=TAOUSDT");
    const data = await res.json();

    const price = parseFloat(data.lastPrice);
    const changePercent = parseFloat(data.priceChangePercent);

    const priceEl = document.getElementById("taoPrice");
    const changeEl = document.getElementById("taoChange");

    // schimbă culoarea prețului în funcție de variație
    if (lastPrice) {
      priceEl.style.color = price > lastPrice ? "#00ff99" : price < lastPrice ? "#ff4444" : "#fff";
    }
    lastPrice = price;

    // afișează prețul actual
    priceEl.textContent = `$${price.toFixed(2)}`;

    // afișează procentul 24h
    // afișează procentul 24h cu emoji
	const emoji = changePercent >= 0 ? "📈" : "📉";
	changeEl.textContent = `${emoji} ${changePercent > 0 ? "+" : ""}${changePercent.toFixed(2)}%`;
	changeEl.style.color = changePercent >= 0 ? "#00ff99" : "#ff4444";


    return price;
  } catch (err) {
    console.error("TAO price fetch failed:", err);
    document.getElementById("taoPrice").textContent = "N/A";
    document.getElementById("taoChange").textContent = "--";
    return 0;
  }
}


// --- Real-time TAO Price Updater (la fiecare 10 secunde) ---
async function startPriceUpdater() {
  const price = await fetchTaoPrice();
  if (wallet && api) await updateBalance();
  setTimeout(startPriceUpdater, 10000); // 10 secunde
}
startPriceUpdater();


// --- SEND TAO ---
document.getElementById("sendBtn").onclick = () => {
  const section = document.getElementById("sendSection");
  section.classList.toggle("hidden");
};

// --- TESTNET TOOLS ---

// 💧 Faucet (deschide cu adresa automată)
document.getElementById("faucetBtn").onclick = () => {
  if (!wallet) return alert("❌ Wallet not found.");
  const faucetUrl = `https://app.minersunion.ai/testnet-faucet?address=${wallet.address}`;
  window.open(faucetUrl, "_blank");
};

// 🧠 Register neuron (hotkey) direct on-chain
document.getElementById("registerBtn").onclick = async () => {
  const status = document.getElementById("registerStatus");
  if (!wallet || !api) return alert("❌ Not connected to network.");

  try {
    status.textContent = "⏳ Registering neuron on subnet 114...";
    const netuid = 114;

    // extrinsic: subtensorModule.register(coldkey, netuid)
const fakeWork = new Uint8Array(130).fill(1); // 130 bytes = minim necesar
const register = api.tx.subtensorModule.register(
  114,
  BigInt(0),
  BigInt(0),
  fakeWork,
  wallet.address,
  wallet.address
);


    const explorerBase = currentNet.rpc.includes("test")
      ? "https://test.taostats.io"
      : "https://taostats.io";

    const unsub = await register.signAndSend(wallet, ({ status: txStatus }) => {
      if (txStatus.isInBlock) {
        status.innerHTML = `✅ Neuron registered!<br>
          <a href="${explorerBase}/tx/${register.hash}" target="_blank" style="color:#1ee0a9;">
            🔗 View on Explorer
          </a>`;
      } else if (txStatus.isFinalized) {
        status.innerHTML += "<br>✅ Finalized!";
        unsub();
      }
    });
  } catch (err) {
    console.error("Register error:", err);
    status.textContent = "❌ Registration failed. You might need faucet TAO first.";
  }
};


// Confirm send (transferStake actualizat)
document.getElementById("confirmSendBtn").onclick = async () => {
  const to = document.getElementById("toAddress").value.trim();
  const amount = parseFloat(document.getElementById("amount").value);
  const status = document.getElementById("txStatus");

  if (!wallet || !api) return alert("❌ Not connected to network.");
  if (!to || isNaN(amount) || amount <= 0) return alert("❌ Invalid input.");

  try {
    status.textContent = "⏳ Sending transaction (subtensorModule.transferStake)...";

    const originNetuid = 114;        // rețeaua ta curentă (Level 114)
    const destinationNetuid = 114;   // transfer în același subnet

    const transfer = api.tx.subtensorModule.transferStake(
      to,                     // destination_coldkey
      wallet.address,         // hotkey (al tău)
      originNetuid,           // subnet sursă
      destinationNetuid,      // subnet destinație
      BigInt(amount * 1e9)    // α amount
    );

    const explorerBase = currentNet.rpc.includes("test")
      ? "https://test.taostats.io"
      : "https://taostats.io";

    const unsub = await transfer.signAndSend(wallet, ({ status: txStatus }) => {
      if (txStatus.isInBlock) {
        status.innerHTML = `✅ Included in block!<br>
          <a href="${explorerBase}/tx/${transfer.hash}" target="_blank" style="color:#1ee0a9;">
            🔗 View on Explorer
          </a>`;
      } else if (txStatus.isFinalized) {
        status.innerHTML += "<br>✅ Finalized!";
        unsub();
      }
    });
  } catch (err) {
    console.error("Send error:", err);
    status.textContent = "❌ Transaction failed.";
  }
};

// --- Injected Wallet for dApps (Polkadot.js compatible) ---
window.injectedWeb3 = window.injectedWeb3 || {};
const allowedDapps = JSON.parse(localStorage.getItem("allowedDapps") || "[]");

window.injectedWeb3["tao-wallet"] = {
  version: "1.0.0",
  enable: async (dappName) => {
    console.log(`🔗 ${dappName} is requesting connection...`);

    // ✅ verifică dacă userul permite accesul
    if (!allowedDapps.includes(dappName)) {
      const confirmAccess = confirm(`${dappName} wants to connect to your TAO Wallet. Allow?`);
      if (!confirmAccess) throw new Error("User rejected connection.");
      allowedDapps.push(dappName);
      localStorage.setItem("allowedDapps", JSON.stringify(allowedDapps));
    }

    // ✅ întoarce obiectul compatibil cu Polkadot API
    return {
      accounts: {
        get: async () => [{ address: wallet.address, name: "TAO Wallet" }]
      },
      signer: {
        signPayload: async (payload) => {
          const { signature } = api.createType("ExtrinsicPayload", payload, { version: payload.version }).sign(wallet);
          return { id: 1, signature };
        },
        signRaw: async ({ data }) => {
          const { signature } = wallet.sign(data);
          return { id: 1, signature };
        }
      }
    };
  }
};

console.log("✅ TAO Wallet injected for dApps!");

window.addEventListener("message", (event) => {
  if (event.data.type === "connect_request") {
    const dapp = event.data.dappName;
    const allow = confirm(`${dapp} wants to connect to your TAO Wallet`);
    if (allow) {
      window.postMessage({
        source: "tao-wallet",
        type: "connect_response",
        approved: true,
        address: localStorage.getItem("taowallet") ? JSON.parse(localStorage.getItem("taowallet")).address : ""
      }, "*");
    }
  }
});

</script>
</body>
</html>

